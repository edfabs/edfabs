{% extends 'skeleton/base.html' %}

{% block title %}{{post.slug}}{% endblock title %}

{% block meta %}
<meta name="description" content="{{ post.meta_description|default:post.excerpt|truncatechars:155 }}">
<meta property="og:title" content="{{ post.meta_title|default:post.title }}">
<meta property="og:description" content="{{ post.meta_description|default:post.excerpt|truncatechars:155 }}">
{% if post.header_image %}<meta property="og:image" content="{{ post.header_image.url }}">{% endif %}
{% endblock meta %}

{% block content %}
{% load static %}
<div class="container py-4">
	<div class="row">
		<div class="col-lg-9 col-sm-12">
			<div class="mb-3 d-flex justify-content-between align-items-start">
				<div>
					<h1 class="mb-1">{{ post.title }}</h1>
					<div class="text-muted small">
						Por {{ post.author.first_name}} {{post.author.last_name}} · {{ post.created_on|date:"d M Y" }}
						{% if post.updated_on and post.updated_on != post.created_on %}
							· <span title="Última actualización">Actualizado {{ post.updated_on|date:"d M Y" }}</span>
						{% endif %}
						· {{ post.views_count }} vistas
					</div>
					<div class="mt-2 d-flex flex-wrap gap-2">
						<span class="badge bg-secondary">{{ post.category }}</span>
						{% for tag in post.tags.all %}
							<a class="badge bg-light text-dark border" href="{% url 'blog:tag' tag.slug %}">#{{ tag.name }}</a>
						{% empty %}
							<span class="badge bg-light text-muted border">Sin etiquetas</span>
						{% endfor %}
					</div>
				</div>
				<div class="d-flex gap-2">
					{% if user.is_authenticated %}
						<form action="{% url 'blog:like_post' post.slug %}" method="POST">
							{% csrf_token %}
							<button type="submit" class="btn btn-outline-primary btn-sm">
								{% if liked %}<i class="bi bi-heart-fill"></i>{% else %}<i class="bi bi-heart"></i>{% endif %}
								<span class="ms-1">{{ total_likes }}</span>
							</button>
						</form>
					{% else %}
						<a class="btn btn-outline-primary btn-sm" href="{% url 'login' %}?next={% url 'blog:detail' post.slug %}">
							<i class="bi bi-heart"></i> {{ total_likes }}
						</a>
					{% endif %}
					{% if user.is_authenticated and user.id == post.author.id %}
						<a class="btn btn-outline-secondary btn-sm" href="{% url 'blog:update_post' post.id %}"><i class="bi bi-pencil"></i></a>
						<a class="btn btn-outline-danger btn-sm" href="{% url 'blog:delete_post' post.pk %}"><i class="bi bi-trash"></i></a>
					{% endif %}
				</div>
			</div>

			{% if post.header_image %}
			<img src="{{post.header_image.url}}" class="img-fluid rounded mb-4" alt="{{ post.title }}">
			{% endif %}

			<article class="mb-4">
				{{post.content|safe}}
			</article>

			{% if related_posts %}
			<div class="mb-4">
				<h5 class="mb-3">Artículos relacionados</h5>
				<div class="row">
					{% for related in related_posts %}
						<div class="col-md-4">
							<div class="card h-100 border-0 shadow-sm">
								<div class="card-body">
									<a class="text-decoration-none" href="{% url 'blog:detail' related.slug %}">{{ related.title }}</a>
									<p class="small text-muted mb-0">{{ related.created_on|date:"d M Y" }}</p>
								</div>
							</div>
						</div>
					{% endfor %}
				</div>
			</div>
			{% endif %}

			<hr>

			<h4 class="mt-4 mb-3">Comentarios ({{ post.comments.count }})</h4>
			{% for comment in post.comments.all %}
				<div class="border rounded p-3 mb-3">
					<div class="d-flex justify-content-between">
						<strong>{{ comment.name }}</strong>
						<small class="text-muted">{{ comment.date_added|date:"d M Y H:i" }}</small>
					</div>
					<p class="mb-0">{{ comment.body|linebreaks }}</p>
				</div>
			{% empty %}
				<p class="text-muted">Aún no hay comentarios. Sé el primero en participar.</p>
			{% endfor %}

			<div class="mt-3">
				{% if user.is_authenticated %}
					<a class="btn btn-primary" href="{% url 'blog:add_comment' post.slug %}">Agregar comentario</a>
				{% else %}
					<p class="text-muted">Inicia sesión para comentar: <a href="{% url 'login' %}">Login</a> o <a href="{% url 'members:register' %}">Regístrate</a>.</p>
				{% endif %}
			</div>

			<div class="mt-4">
				<a href="{% url 'blog:index' %}" class="text-decoration-none"><i class="bi bi-arrow-left"></i> Volver al blog</a>
			</div>
		</div>

		<div class="col-lg-3 col-sm-12">
			<div class="card mb-3">
				<div class="row g-0 align-items-center">
					<div class="col-4 col-md-12 text-center p-3">
						{% if post.author.profile.profile_pic %}
							<img src="{{ post.author.profile.profile_pic.url }}" class="img-fluid rounded-circle" alt="{{ post.author.first_name}}">
						{% else %}
							<img src="{% static 'images/profile/default_profile.png' %}" class="img-fluid rounded-circle" alt="{{ post.author.first_name}}">
						{% endif %}
					</div>
					<div class="col-8 col-md-12">
						<div class="card-body">
							<h5 class="card-title mb-1">{{ post.author.first_name}} {{post.author.last_name}}</h5>
							<p class="small text-muted mb-2">
								<a href="{% url 'members:show_profile_page' post.author.profile.id %}">Perfil</a>
								{% if post.author.profile.website_url %}
									| <a href="{{post.author.profile.website_url}}" target="blank">Sitio</a>
								{% endif %}
							</p>
							<p class="card-text small mb-0">{{ post.author.profile.bio }}</p>
						</div>
					</div>
				</div>
			</div>

			{% if cat_menu %}
			<div class="card mb-3">
				<div class="card-header">Categorías</div>
				<ul class="list-group list-group-flush">
					{% for category in cat_menu %}
						<li class="list-group-item d-flex justify-content-between align-items-center">
							<a href="{% url 'blog:category' category.slug %}" class="text-decoration-none">{{ category.name }}</a>
						</li>
					{% endfor %}
				</ul>
			</div>
			{% endif %}

			{% if post.tags.all %}
			<div class="card">
				<div class="card-header">Etiquetas</div>
				<ul class="list-group list-group-flush">
					{% for tag in post.tags.all %}
						<li class="list-group-item"><a href="{% url 'blog:tag' tag.slug %}" class="text-decoration-none">#{{ tag.name }}</a></li>
					{% endfor %}
				</ul>
			</div>
			{% endif %}
		</div>
	</div>
</div>
{% endblock content %}
